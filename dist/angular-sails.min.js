!function(e,t){"use strict";e.module("ngSails",["ng"]),function(e,t){function n(t){var n,o,s,u={};return t?(e.forEach(t.split("\n"),function(e){s=e.indexOf(":"),n=lowercase(r(e.substr(0,s))),o=r(e.substr(s+1)),n&&(u[n]=u[n]?u[n]+", "+o:o)}),u):u}function r(t){return e.isString(t)?t.trim():t}function o(t){return t&&e.isFunction(t.then)}function s(t){var r=e.isObject(t)?t:void 0;return function(e){if(r||(r=n(t)),e){var o=r[lowercase(e)];return void 0===o&&(o=null),o}return r}}t.sails&&(t.sails.autoConnect=!1),e.module("ngSails").provider("$sails",function(){var n=this;this.httpVerbs=["get","post","put","delete"],this.eventNames=["on","off"],this.url=void 0,this.urlPrefix="",this.config={transports:["polling","websocket"],useCORSRouteToGetCookie:!0},n.useCSRFToken=!1,n.csrfTokenAsHeader=!0;var r,u=n.interceptors=[];this.$get=["$q","$injector","$rootScope","$log","$timeout",function(i,a,c,f,d){function l(e){function t(){n(null)}function n(t,n){n||(n={body:t,headers:t.headers||{},statusCode:t.statusCode||t.status||0,error:function(){return this.statusCode<200||this.statusCode>=400?this.body||this.statusCode:void 0}()}),n.data=n.body,n.status=n.statusCode,n.socket=v,n.url=e.url,n.method=e.method,n.config=e.config,n.error?(f.warn("$sails response "+n.statusCode+" "+e.url,n),r.reject(n)):(f.info("$sails response "+e.url,n),r.resolve(n))}var r=i.defer(),s={url:e.url,method:e.method,params:e.data||{},headers:e.headers||{}};return f.info("$sails "+e.method+" "+e.url,e.headers||"",e.data||""),e.timeout>0?d(t,e.timeout):o(e.timeout)&&e.timeout.then(t),v.request(s,n),r.promise}function h(t){v[t]=function(r,o,u){var a=[l,void 0],c={url:n.urlPrefix+r,data:o,socket:v,config:u||{},method:t.toUpperCase()},f=i.when(c);for(e.forEach(g,function(e){(e.request||e.requestError)&&a.unshift(e.request,e.requestError),(e.response||e.responseError)&&a.push(e.response,e.responseError)});a.length;){var d=a.shift(),h=a.shift();f=f.then(d,h)}return f.success=function(e){return f.then(function(t){e(t.body,t.statusCode,s(t.headers),t)}),f},f.error=function(e){return f.then(null,function(t){e(t.body,t.statusCode,s(t.headers),t)}),f},f}}function p(t){(v[t]||v._raw&&v._raw[t])&&(v["legacy_"+t]=v[t]||v._raw[t],v[t]=function(n,r){var o=null;return"off"==t?v["legacy_"+t](n,r):(null!==r&&e.isFunction(r)&&v["legacy_"+t](n,o=function(e){c.$evalAsync(r.bind(v,e))}),o)})}var v=(t.sails&&t.sails.connect||t.connect)(n.url,n.config);r=i.defer(),v.connect=function(t){if(!v.isConnected()){var r=t||{};r=e.extend({},n.config,t),v.useCORSRouteToGetCookie=r.useCORSRouteToGetCookie,v.url=r.url||n.url,v.multiplex=r.multiplex,v._connect()}return v},n.useCSRFToken&&u.push(function(e){return{request:function(t){if("get"!==t.method.toLowerCase()&&n.useCSRFToken){var o=e.defer();return e.when(r.promise).then(function(e){n.csrfTokenAsHeader?(t.headers=t.headers||{},t.headers["X-CSRF-Token"]=e,o.resolve(t)):(t.data=t.data||{},t.data._csrf=e)}),o.promise}return t}}});var g=[];return e.forEach(u,function(t){g.unshift(e.isString(t)?a.get(t):a.invoke(t))}),v.once=function(t,n){null!==n&&e.isFunction(n)&&v._raw&&v._raw.once(t,function(e){c.$evalAsync(n.bind(v,e))})},e.forEach(n.httpVerbs,h),e.forEach(n.eventNames,p),v.$modelUpdater=function(t,n){var r=function(t){c.$evalAsync(function(){var r;switch(t.verb){case"created":n.push(t.data);break;case"updated":var o;for(r=0;r<n.length;r++)if(n[r].id===t.id){o=n[r];break}if(!o&&!t.previous)return;o||(o=t.previous,n.push(o)),e.extend(o,t.data);break;case"destroyed":for(r=0;r<n.length;r++)if(n[r].id===t.id){n.splice(r,1);break}}})};return v.legacy_on(t,r),function(){v.legacy_off(t,r)}},n.useCSRFToken&&v.get("/csrfToken").then(function(e){f.debug(e.data._csrf),r.resolve(e.data._csrf)}),v}],this.$get.$inject=["$q","$injector","$rootScope","$log","$timeout"]})}(e,t)}(angular,io);